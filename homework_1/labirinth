# импортируем рандом для случайных чисел
import random

# класс для игрока
class Player:
    # конструктор класса
    def __init__(self):
        self.hp = 100  # здоровье
        self.mana = 50  # мана
        self.attack = 15  # атака
        self.defense = 5  # защита

# функция для выбора скиллов игрока
def player_skills(mana, attack):
    damage = 0  # урон сначала 0
    # показываем навыки
    print("Доступные навыки:")
    print("1) Базовая атака (Расход маны: 0, Урон: 100% от атаки)")
    print("2) Сильная атака (Расход маны: 10, Урон: 150% от атаки)")
    print("3) Особая атака (Расход маны: 20, Урон: 200% от атаки)")
    print("Выберите навык для использования:")
    
    # цикл пока не выберет правильный скилл
    while True:
        try:
            ch = int(input())  # вводим число
            
            if ch == 1:
                # базовая атака
                damage = attack
                break  # выходим из цикла
            elif ch == 2:
                # проверяем ману
                if mana >= 10:
                    damage = int(attack * 1.5)  # умножаем на 1.5
                    mana = mana - 10  # отнимаем ману
                    break
                else:
                    print("Недостаточно маны! Выберите другой навык:")
            elif ch == 3:
                if mana >= 20:
                    damage = int(attack * 2.0)  # умножаем на 2
                    mana = mana - 20
                    break
                else:
                    print("Недостаточно маны! Выберите другой навык:")
            else:
                # если выбрал не 1,2,3
                print("Неправильный выбор! Введите 1, 2 или 3:")
        except:
            # если ввел не число
            print("Ошибка! Нужно ввести число!")

    # возвращаем ману и урон
    return [mana, damage]

# класс для монстра
class Monster:
    def __init__(self):
        self.hp = 60
        self.attack = 12
        self.defense = 3

# функция для боя с монстром
def fight_monster(player_hp, player_mana, player_attack, backpack):
    # создаем монстра
    m = Monster()
    
    print("Вы встретили Монстра!")
    print("Здоровье врага:", m.hp)
    print("Атака врага:", m.attack)
    print("Защита врага:", m.defense)
    
    # проверяем есть ли яд в рюкзаке
    have_poison = False
    for item in backpack:
        if item == 'Poison':
            have_poison = True
    
    if have_poison:
        print("У вас есть яд! Использовать его? (Y/N)")
        choice = input().upper()  # делаем большую букву
        if choice == 'Y':
            # удаляем яд из рюкзака
            backpack.remove('Poison')
            # наносим урон монстру
            m.hp = m.hp - 20
            print("Монстр отравлен! -20 HP")
    
    # цикл боя
    while m.hp > 0 and player_hp > 0:
        print("\n--- Ход игрока ---")
        print("Здоровье монстра:", m.hp)
        print("Ваше здоровье:", player_hp)
        print("Ваша мана:", player_mana)
        
        # ход игрока
        res = player_skills(player_mana, player_attack)
        player_mana = res[0]
        dmg = res[1]
        
        # учитываем защиту монстра
        real_damage = dmg - m.defense
        if real_damage < 0:
            real_damage = 0
        
        m.hp = m.hp - real_damage
        print(f"Вы нанесли {real_damage} урона!")
        
        # проверяем убит ли монстр
        if m.hp <= 0:
            print("Монстр побежден!")
            break
        
        print("\n--- Ход монстра ---")
        # монстр атакует
        monster_dmg = m.attack - 2  # у игрока есть защита
        if monster_dmg < 0:
            monster_dmg = 0
        
        player_hp = player_hp - monster_dmg
        print(f"Монстр атакует! Вы получаете {monster_dmg} урона")
    
    # восстанавливаем немного маны после боя
    player_mana = player_mana + 5
    if player_mana > 50:
        player_mana = 50
    
    return [m.hp, player_hp, player_mana, backpack]

# функция для открытия сундука
def chest_loot(backpack):
    # список возможных предметов
    items_list = ['Healing potion', 'Power Up', 'Poison']
    
    # выбираем случайный предмет
    random_item = random.choice(items_list)
    
    # добавляем в рюкзак
    backpack.append(random_item)
    
    print(f"Вы нашли: {random_item}!")
    
    # описание предмета
    if random_item == 'Healing potion':
        print("Восстанавливает 20 HP при использовании")
    elif random_item == 'Power Up':
        print("Увеличивает ваши характеристики")
    elif random_item == 'Poison':
        print("Наносит 20 урона врагу в начале боя")
    
    return backpack

# функция для использования зелья лечения
def use_healing_potion(hp, backpack):
    # проверяем есть ли зелье
    have_potion = False
    for item in backpack:
        if item == 'Healing potion':
            have_potion = True
    
    if have_potion:
        # удаляем зелье
        backpack.remove('Healing potion')
        # лечимся
        hp = hp + 20
        if hp > 100:
            hp = 100
        print("Использовано зелье лечения! +20 HP")
    else:
        print("У вас нет зелий лечения!")
    
    return [hp, backpack]

# функция для использования усиления
def use_power_up(player, backpack):
    # проверяем есть ли усиление
    have_power = False
    for item in backpack:
        if item == 'Power Up':
            have_power = True
    
    if have_power:
        # удаляем предмет
        backpack.remove('Power Up')
        # улучшаем характеристики
        player.hp = player.hp + 10
        player.attack = player.attack + 5
        player.defense = player.defense + 2
        print("Характеристики улучшены!")
        print(f"HP: +10, Атака: +5, Защита: +2")
    else:
        print("У вас нет усиления!")
    
    return backpack

# функция для показа рюкзака
def show_backpack(backpack):
    if len(backpack) == 0:
        print("Рюкзак пуст!")
    else:
        print("Содержимое рюкзака:")
        # считаем предметы
        items_count = {}
        for item in backpack:
            if item in items_count:
                items_count[item] = items_count[item] + 1
            else:
                items_count[item] = 1
        
        # выводим
        for item, count in items_count.items():
            print(f"{item}: {count} шт.")

# функция для показа характеристик
def show_stats(player):
    print("=== ХАРАКТЕРИСТИКИ ИГРОКА ===")
    print(f"Здоровье (HP): {player.hp}/100")
    print(f"Мана: {player.mana}/50")
    print(f"Атака: {player.attack}")
    print(f"Защита: {player.defense}")
    print("=============================")

# основная функция игры
def main():
    print("=== ДОБРО ПОЖАЛОВАТЬ В ПОДЗЕМЕЛЬЕ ===")
    print("Цель: найти портал и сбежать!")
    print("=====================================")
    
    # создаем игрока
    p = Player()
    
    # создаем лабиринт
    print("Введите размер подземелья (например: 5 5):")
    try:
        size_input = input()
        parts = size_input.split()
        n = int(parts[0])  # ширина
        m = int(parts[1])  # высота
    except:
        print("Ошибка! Будут использованы размеры по умолчанию 5x5")
        n = 5
        m = 5
    
    # типы комнат
    # E - пустая, C - сундук, M - монстр
    room_types = ['E', 'C', 'M']
    
    # создаем лабиринт
    lab = []
    for i in range(m):  # строки
        row = []
        for j in range(n):  # столбцы
            # случайная комната
            room = random.choice(room_types)
            row.append(room)
        lab.append(row)
    
    # помещаем портал в конец
    lab[m-1][n-1] = 'P'
    # стартовая позиция
    lab[0][0] = 'E'
    
    # карта для отображения
    display_map = []
    for i in range(m):
        row = []
        for j in range(n):
            row.append('*')  # неисследовано
        display_map.append(row)
    
    # позиция игрока
    display_map[0][0] = 'X'
    
    # координаты игрока
    x = 0
    y = 0
    
    # рюкзак
    backpack = []
    
    # есть ли ключ
    has_key = False
    
    print("\n=== УПРАВЛЕНИЕ ===")
    print("w - вверх")
    print("s - вниз")
    print("a - влево")
    print("d - вправо")
    print("stats - показать характеристики")
    print("backpack - показать рюкзак")
    print("heal - использовать зелье лечения")
    print("powerup - использовать усиление")
    print("==================")
    
    # главный игровой цикл
    game_over = False
    while not game_over and p.hp > 0:
        # показываем карту
        print("\n--- КАРТА ---")
        for row in display_map:
            print(' '.join(row))
        print("X - вы, * - неисследовано")
        print("---------------")
        
        # ввод команды
        print("\nВведите команду:")
        cmd = input().lower()
        
        # обработка команд
        if cmd == 'w':
            # движение вверх
            if y > 0:
                display_map[y][x] = 'V'  # посещенная комната
                y = y - 1
                display_map[y][x] = 'X'
                print("Вы двинулись наверх")
            else:
                print("Нельзя идти наверх!")
                continue
        elif cmd == 's':
            if y < m-1:
                display_map[y][x] = 'V'
                y = y + 1
                display_map[y][x] = 'X'
                print("Вы двинулись вниз")
            else:
                print("Нельзя идти вниз!")
                continue
        elif cmd == 'a':
            if x > 0:
                display_map[y][x] = 'V'
                x = x - 1
                display_map[y][x] = 'X'
                print("Вы двинулись влево")
            else:
                print("Нельзя идти влево!")
                continue
        elif cmd == 'd':
            if x < n-1:
                display_map[y][x] = 'V'
                x = x + 1
                display_map[y][x] = 'X'
                print("Вы двинулись вправо")
            else:
                print("Нельзя идти вправо!")
                continue
        elif cmd == 'stats':
            show_stats(p)
            continue
        elif cmd == 'backpack':
            show_backpack(backpack)
            continue
        elif cmd == 'heal':
            res = use_healing_potion(p.hp, backpack)
            p.hp = res[0]
            backpack = res[1]
            continue
        elif cmd == 'powerup':
            backpack = use_power_up(p, backpack)
            continue
        else:
            print("Неизвестная команда!")
            continue
        
        # проверка что в комнате
        room = lab[y][x]
        
        if room == 'E':
            print("Комната пуста")
            # восстанавливаем ману
            p.mana = p.mana + 5
            if p.mana > 50:
                p.mana = 50
            print("Мана восстановлена на 5")
        
        elif room == 'C':
            print("Вы нашли сундук!")
            backpack = chest_loot(backpack)
            p.mana = p.mana + 5
            if p.mana > 50:
                p.mana = 50
        
        elif room == 'M':
            print("В комнате монстр!")
            res = fight_monster(p.hp, p.mana, p.attack, backpack)
            
            # обновляем здоровье и ману
            p.hp = res[1]
            p.mana = res[2]
            backpack = res[3]
            
            if p.hp <= 0:
                print("Вы погибли!")
                game_over = True
                break
            
            # шанс найти ключ
            if not has_key:
                chance = random.randint(1, 10)  # от 1 до 10
                if chance <= 3:  # 30% шанс
                    has_key = True
                    print("Вы нашли ключ от портала!")
        
        elif room == 'P':
            print("Вы нашли портал!")
            if has_key:
                print("У вас есть ключ! Вы сбежали из подземелья!")
                game_over = True
                break
            else:
                print("У вас нет ключа! Найдите ключ чтобы использовать портал")
                p.mana = p.mana + 5
                if p.mana > 50:
                    p.mana = 50
        
        # проверка здоровья
        if p.hp <= 0:
            print("Игра окончена! Вы погибли!")
            game_over = True
    
    # конец игры
    print("\n=== ИГРА ОКОНЧЕНА ===")
    if p.hp > 0:
        print("ПОБЕДА! Вы сбежали из подземелья!")
    else:
        print("ПОРАЖЕНИЕ! Попробуйте еще раз!")
    print("======================")

# запуск игры
if __name__ == "__main__":
    main()
